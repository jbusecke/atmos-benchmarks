#!/bin/bash
ncfile=$1
flags="-s -O"
g=9.80 # gravity
R=287.04 # dry gas constant
cp=1004.64 # R divided by kappa (2/7)
function wrapup() { # segregate the grids
  [ ! -r $1 ] && echo "ERROR: File $1 not found." && exit 3
  ncrename -O -d lon,x -d lat,y $1 $1 # renames the singleton dimensions
  ncatted -O -a units,x,d,, $1
  ncatted -O -a standard_name,x,d,, $1
  ncatted -O -a long_name,x,c,c,"X" $1
  ncatted -O -a units,y,d,, $1
  ncatted -O -a long_name,y,d,, $1
  ncatted -O -a standard_name,y,c,c,"Y" $1
} # tests if a given file was created or if the CDO script failed for some reason

# Misc terms: eddy kinetic energy EKE
# * EKE should be multiplied by level width dP; final units are J/m2
t=$(date +%s)
out=basic5.nc
cdo $flags -setattribute,EKE@long_name="eddy kinetic energy",EKE@units="J/m2 Pa" \
  -chname,u,EKE -divc,9.81 -divc,2 \
  -add -zonmean -sqr -sub -selvar,u $ncfile -enlarge,$ncfile -zonmean -selvar,u $ncfile \
       -zonmean -sqr -sub -selvar,v $ncfile -enlarge,$ncfile -zonmean -selvar,v $ncfile \
  $out; verify $out
echo "  * Time for EKE: $(($(date +%s) - $t))s."
t=$(date +%s)
